<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Joel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    html,
    body {
      background: pink;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #captcha-container {
      background: white;
      width: 390px;
      height: 300px;
    }

    /* Your style here... */
  </style>
  <link rel="stylesheet" href="captcha.css">
</head>

<body>
  <div id="captcha-container">
    <!-- Add your CAPTCHA here: -->
    <div id="captchaWrapper">
      <div id="horizontalArrowId" class="horizontalArrow">
        <div class="arrowLeft"></div>
        <div class="horizontalArrowBody"></div>
        <div class="arrowRight"></div>
      </div>
      <div id="verticalArrowId" class="verticalArrow">
        <div class="arrowUp"></div>
        <div class="verticalArrowBody"></div>
        <div class="arrowDown"></div>
      </div>
    <div id="speechBubbleStartId"></div>
    <div id="speechBubbleId"></div>
    <div id="starId"></div>
  </div>

    

  </div>

  <script type="text/javascript">

    //var t = setInterval(runFunction,1000);

    let cursorPositionX = 0;
    let cursorPositionY = 0;
    let petProgressionCounter = 0;
    let lastMovementDate = new Date();
    let remainingPetCounter = 3;
    let petProgressionGoal = 7;
    document.getElementById('starId').classList.add("hidden")
    document.getElementById("speechBubbleId").innerHTML = "Hi! My name is <b>Mods</b>. <br> Pet me <b>"+remainingPetCounter+"</b></div> times!";

    if(remainingPetCounter % 2 == 1){
      document.getElementById('horizontalArrowId').classList.remove("hidden")
      document.getElementById('verticalArrowId').classList.add("hidden")
    }
    else{
      document.getElementById('horizontalArrowId').classList.add("hidden")
      document.getElementById('verticalArrowId').classList.remove("hidden")
    }

    (function(window, document){
      // This is how you tell the parent window that the CAPTCHA was successful.
      function captchaSuccess() {
        window.top.postMessage("success", '*');
      }

      // Track cursor position
      document.addEventListener('mousemove', function(event) {
          cursorPositionX = event.clientX;
          cursorPositionY = event.clientY;

      });

      // Pet by moving the cursor inside of the marked area.
      function petTheMods(){
        let nowDate = new Date();

        // wait some time between pet progression
        // TOOD: eliminate magic number
        if(nowDate.getTime() > lastMovementDate.getTime() + 800)
        {
          lastMovementDate = new Date();
          petProgressionCounter = petProgressionCounter + 1;
          //TODO: Remove console logs
          console.log(petProgressionCounter);  

          
          let animationCount = petProgressionCounter+ 1;
          
          // Calculate position of the star. Make sure it is in the 300x390 frame.
          let starX = cursorPositionX - 15;
          let starY = cursorPositionY - 15;
          if(starY >= 260){
            starY = 260;
          }
          if(starY <= 40){
            starY = 40;
          }
          if(starX >= 350){
            starX = 350;
          }
          if(starX <= 40){
            starX = 40;
          }
        
          document.getElementById("starId").classList.remove("hidden")
          document.getElementById("starId").setAttribute("style", "left: "+starX+"px;top: "+starY+"px;")
          setTimeout(hideStar, 700);

          // Last pet is done, end captcha.
          if(petProgressionCounter >= petProgressionGoal && remainingPetCounter == 1){
            document.getElementById('horizontalArrowId').classList.add("hidden")
            document.getElementById("speechBubbleId").innerHTML = "Good Job, human!";
            setTimeout(() => {
              captchaSuccess();
            }, 2000);
            
          }
          // Progression counter is high enough count down remaining pets.
          else if(petProgressionCounter >= petProgressionGoal)
          {
            petProgressionCounter = 0;
            remainingPetCounter = remainingPetCounter - 1;
            
            if(remainingPetCounter == 1){
              //TODO: Use variable, instead of calling it multiple times
              document.getElementById("speechBubbleId").innerHTML = "Hi! My name is <b>Mods</b>. <br> Pet me <b>1</b> more time!";
            }
            else{
              document.getElementById("speechBubbleId").innerHTML = "Hi! My name is <b>Mods</b>. <br> Pet me <b>"+remainingPetCounter+"</b></div> more times!";
            }
            

            if(remainingPetCounter % 2 == 1){
              document.getElementById('horizontalArrowId').classList.remove("hidden")
              document.getElementById('verticalArrowId').classList.add("hidden")
            }
            else{
              document.getElementById('horizontalArrowId').classList.add("hidden")
              document.getElementById('verticalArrowId').classList.remove("hidden")
            }
          }
        }
        
      }

      function hideStar(){
        document.getElementById("starId").classList.add("hidden");
      }

      // Your CAPTCHA code goes here, we've added a simple example below:
      /*document.getElementById('solve')
           .addEventListener('click', () => captchaSuccess());*/
      
      document.getElementById('horizontalArrowId')
           .addEventListener('mousemove', () => petTheMods());
      document.getElementById('verticalArrowId')
           .addEventListener('mousemove', () => petTheMods());
         

    })(window, document);


  </script>
</body>
</html>
